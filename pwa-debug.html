<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWAデバッグツール</title>
    
    <!-- デバッグ用：メインアプリと同じ設定を読み込む -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ロシア語学習">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f0f0f0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .info-item {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <h1>PWAデバッグツール</h1>
    
    <div id="results"></div>
    
    <h2>アクション</h2>
    <button onclick="checkAll()">全てチェック</button>
    <button onclick="registerSW()">サービスワーカー登録</button>
    <button onclick="unregisterSW()">サービスワーカー解除</button>
    <button onclick="clearCache()">キャッシュクリア</button>
    <button onclick="window.location.href='index.html'">メインアプリへ</button>
    
    <h2>インストール手順</h2>
    <div class="info-item">
        <h3>iOS (Safari)</h3>
        <ol>
            <li>Safariで当サイトを開く</li>
            <li>共有ボタン（□↑）をタップ</li>
            <li>「ホーム画面に追加」を選択</li>
            <li>名前を確認して「追加」をタップ</li>
        </ol>
    </div>
    
    <div class="info-item">
        <h3>Android (Chrome)</h3>
        <ol>
            <li>Chromeで当サイトを開く</li>
            <li>メニュー（⋮）をタップ</li>
            <li>「ホーム画面に追加」を選択</li>
            <li>「追加」をタップ</li>
        </ol>
    </div>
    
    <script>
        const results = document.getElementById('results');
        
        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}:</strong><br>${content}`;
            results.appendChild(div);
        }
        
        function checkAll() {
            results.innerHTML = '';
            
            // 基本情報
            addResult('URL', window.location.href);
            addResult('プロトコル', window.location.protocol);
            addResult('User Agent', navigator.userAgent);
            
            // HTTPS確認
            if (window.location.protocol === 'https:' || window.location.hostname === 'localhost') {
                addResult('HTTPS/localhost', '✓ OK', 'success');
            } else {
                addResult('HTTPS', '✗ HTTPSが必要です', 'error');
            }
            
            // サービスワーカー確認
            if ('serviceWorker' in navigator) {
                addResult('Service Worker API', '✓ サポートされています', 'success');
                
                navigator.serviceWorker.getRegistrations().then(regs => {
                    if (regs.length > 0) {
                        regs.forEach(reg => {
                            addResult('登録済みSW', `
                                Scope: ${reg.scope}<br>
                                Active: ${reg.active ? reg.active.state : 'なし'}<br>
                                Waiting: ${reg.waiting ? reg.waiting.state : 'なし'}
                            `, 'success');
                        });
                    } else {
                        addResult('Service Worker', '登録されていません', 'warning');
                    }
                });
            } else {
                addResult('Service Worker API', '✗ サポートされていません', 'error');
            }
            
            // マニフェスト確認
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                addResult('Manifest', `✓ ${manifestLink.href}`, 'success');
                
                fetch(manifestLink.href)
                    .then(res => res.json())
                    .then(manifest => {
                        addResult('Manifest内容', `<pre>${JSON.stringify(manifest, null, 2)}</pre>`);
                    })
                    .catch(err => {
                        addResult('Manifest読み込み', `エラー: ${err}`, 'error');
                    });
            } else {
                addResult('Manifest', '✗ リンクがありません', 'error');
            }
            
            // iOS PWA確認
            const iosMeta = {
                'apple-mobile-web-app-capable': document.querySelector('meta[name="apple-mobile-web-app-capable"]'),
                'apple-mobile-web-app-status-bar-style': document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]'),
                'apple-mobile-web-app-title': document.querySelector('meta[name="apple-mobile-web-app-title"]')
            };
            
            let iosOk = true;
            for (const [name, elem] of Object.entries(iosMeta)) {
                if (elem) {
                    addResult(`iOS: ${name}`, `✓ ${elem.content}`, 'success');
                } else {
                    addResult(`iOS: ${name}`, '✗ 未設定', 'warning');
                    iosOk = false;
                }
            }
            
            // スタンドアロンモード確認
            if (window.matchMedia('(display-mode: standalone)').matches) {
                addResult('表示モード', '✓ スタンドアロンモード', 'success');
            } else if (window.navigator.standalone) {
                addResult('表示モード', '✓ iOS スタンドアロンモード', 'success');
            } else {
                addResult('表示モード', 'ブラウザモード', 'warning');
            }
        }
        
        function registerSW() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        addResult('SW登録', '成功', 'success');
                        setTimeout(checkAll, 1000);
                    })
                    .catch(err => {
                        addResult('SW登録', `エラー: ${err}`, 'error');
                    });
            }
        }
        
        function unregisterSW() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(regs => {
                    regs.forEach(reg => reg.unregister());
                    addResult('SW解除', '完了', 'success');
                    setTimeout(checkAll, 1000);
                });
            }
        }
        
        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                    addResult('キャッシュクリア', '完了', 'success');
                });
            }
        }
        
        // 初期チェック
        checkAll();
    </script>
</body>
</html>